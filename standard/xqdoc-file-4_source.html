<html xml:space="preserve"><head><title>xqDoc -- Code Sample</title></head><body xml:space="preserve"><pre>(:<br/> : Copyright (c)2005 Elsevier, Inc.<br/> :<br/> : Licensed under the Apache License, Version 2.0 (the "License");<br/> : you may not use this file except in compliance with the License.<br/> : You may obtain a copy of the License at<br/> :<br/> : http://www.apache.org/licenses/LICENSE-2.0<br/> :<br/> : Unless required by applicable law or agreed to in writing, software<br/> : distributed under the License is distributed on an "AS IS" BASIS,<br/> : WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.<br/> : See the License for the specific language governing permissions and<br/> : limitations under the License.<br/> :<br/> : The use of the Apache License does not indicate that this project is<br/> : affiliated with the Apache Software Foundation.<br/> :)<br/><br/>(:~ <br/> :  This module provides the functions that control the Web presentation<br/> :  of xqDoc. The logic contained in this module is not specific to any<br/> :  XQuery implementation and is written to the May 2003 XQuery working<br/> :  draft specification.  <br/> :<br/> :  It should also be noted that these functions not only support the <br/> :  real-time presentation of the xqDoc information but are also used<br/> :  for the static offline presentation mode as well.  The static offline<br/> :  presentation mode has advantages because access to a native XML <br/> :  database is not needed when viewing the xqDoc information ... it is<br/> :  only needed when generating the offline materials. <br/> : <br/> :  @author Darin McBeath<br/> :  @since February 27, 2005<br/> :  @version 1.1<br/> :)<br/><br/>module "xqdoc/xqdoc-display"<br/><br/>declare namespace display="xqdoc/xqdoc-display"<br/><br/>declare namespace xq="http://www.xqdoc.org/1.0"<br/><br/>(:~ <br/> :  This variable defines the name for the xqDoc collection.<br/> :  The xqDoc XML for all modules should be stored into the<br/> :  XML database with this collection value.<br/> :)<br/>define variable $display:XQDOC_COLLECTION as xs:string {"xqdoc" }<br/><br/>(:~ <br/> :  This variable contains the list of URIs for all of the modules<br/> :  available to xqDoc for presentation.  Each module should be identified by<br/> :  a unique URI in the XML databse. <br/> :)<br/>define variable $display:XQDOC_URIS as xs:string* { for $x in fn:collection($display:XQDOC_COLLECTION)/xq:xqdoc<br/>                                                    order by $x/xq:module/xq:uri <br/>                                                    return fn:base-uri($x) }<br/>(:~ <br/> :  Construct the welcome banner for the xqDoc home page.<br/> :<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic linke for real-time viewing.<br/> :  @return HTML.<br/> :)<br/>define function display:print-intro($local as xs:boolean) as element()+<br/>{<br/>  (&lt;h3&gt;Welcome to xqDoc&lt;/h3&gt;,<br/>  &lt;div class="overview"&gt;<br/>  &lt;p&gt;This site presents documentation and cross-referencing information for both XQuery library<br/>  and main modules that have been converted into xqDoc XML.  <br/>  Visit &lt;a href="http://www.xqdoc.org"&gt;xqdoc.org&lt;/a&gt; to find the latest developments for this XQuery<br/>  open source tool.&lt;/p&gt;<br/>  &lt;/div&gt;<br/>  )<br/>}<br/><br/>(:~<br/> :  Construct the welcome banner for the xqDoc module page.<br/> :<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML.<br/> :)<br/>define function display:print-module-intro($local as xs:boolean) as element()<br/>{<br/>  display:build-link("default", $local, (), ())<br/>}<br/><br/>(:~<br/> :  Construct the list of modules available to xqDoc for presentation.<br/> :  The list of modules is availalbe on the xqDoc home page.<br/> :<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML.<br/> :)<br/>define function display:print-modules($local as xs:boolean) as element()+<br/>{<br/>  (&lt;div class="home"&gt;<br/>    {<br/>    if (fn:exists(fn:collection($display:XQDOC_COLLECTION)/xq:xqdoc/xq:module[@type="library"])) then<br/>      (&lt;h4&gt;Library Modules&lt;/h4&gt;,<br/>        &lt;br/&gt;,&lt;br/&gt;,<br/>        for $x in fn:collection($display:XQDOC_COLLECTION)/xq:xqdoc[xq:module/@type="library"]<br/>        order by $x/xq:module/xq:uri<br/>        return<br/>         ( display:build-link("get-module",<br/>                              $local, <br/>                              (fn:base-uri($x)),<br/>                               display:decode-uri(fn:string($x/xq:module/xq:uri))),<br/>           &lt;br/&gt; )<br/>        )           <br/>    else<br/>      ()<br/>    }<br/>    {<br/>    if (fn:exists(fn:collection($display:XQDOC_COLLECTION)/xq:xqdoc/xq:module[@type="main"])) then<br/>      (&lt;h4&gt;Main Modules&lt;/h4&gt;,<br/>        &lt;br/&gt;,&lt;br/&gt;,<br/>        for $x in fn:collection($display:XQDOC_COLLECTION)/xq:xqdoc[xq:module/@type="main"]<br/>        order by $x/xq:module/xq:uri<br/>        return<br/>         ( display:build-link("get-module",<br/>                               $local, <br/>                               (fn:base-uri($x)),<br/>                                display:decode-uri(xs:string($x/xq:module/xq:uri))),<br/>           &lt;br/&gt; )<br/>      )<br/>    else<br/>      ()<br/>    }<br/>    &lt;/div&gt;)<br/>}<br/><br/>(:~<br/> :  The controller for constructing the xqDoc HTML information for<br/> :  the specified module. The following information  for<br/> :  each module will be generated.<br/> :  &lt;ul&gt;<br/> :  &lt;li&gt; Module introductory information&lt;/li&gt;<br/> :  &lt;li&gt; Global variables declared in this module&lt;/li&gt;<br/> :  &lt;li&gt; Modules imported by this module&lt;/li&gt;<br/> :  &lt;li&gt; Summary information for each function defined in the module&lt;/li&gt;<br/> :  &lt;li&gt; Detailed information for each function defined in the module&lt;/li&gt;<br/> :  &lt;/ul&gt;<br/> :<br/> :  @param $uri the URI for the module<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML.<br/> :)<br/>define function display:print-module-control($uri as xs:string, $local as xs:boolean) as item()+ <br/>{<br/>  ( display:print-module($uri, $local),<br/>    display:print-variables($uri, $local),<br/>    "&amp;#160;",<br/>    display:print-imports($uri, $local),<br/>    "&amp;#160;",<br/>    display:print-method-summary($uri),<br/>    "&amp;#160;",<br/>    display:print-method-detail($uri, $local),<br/>    display:print-footer($uri) )<br/>}<br/><br/>(:~<br/> :  Construct the high-level xqDoc HTML for the module.<br/> :  This is essentially any introductory xqDoc comments that might<br/> :  be associated with the module.<br/> :<br/> :  @param $uri the URI for the module<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML.<br/> :)<br/>define function display:print-module($uri as xs:string, $local as xs:boolean) as element()* <br/>{<br/>   (&lt;h4&gt;Module URI&lt;/h4&gt;,<br/>    &lt;h1&gt;{ display:decode-uri(xs:string(fn:doc($uri)/xq:xqdoc/xq:module/xq:uri)) }&lt;/h1&gt;,<br/>    if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:module/xq:body)) then<br/>        display:build-link("get-code",<br/>                           $local, <br/>                           $uri,<br/>                           ())<br/>             else<br/>              (),<br/>    if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:module/xq:comment/xq:description) or<br/>         fn:exists(fn:doc($uri)/xq:xqdoc/xq:module/xq:comment/xq:author) or<br/>         fn:exists(fn:doc($uri)/xq:xqdoc/xq:module/xq:comment/xq:version) or<br/>         fn:exists(fn:doc($uri)/xq:xqdoc/xq:module/xq:comment/xq:since) or<br/>         fn:exists(fn:doc($uri)/xq:xqdoc/xq:module/xq:comment/xq:see)) then<br/>           (&lt;h4&gt;Module Description&lt;/h4&gt;,<br/>            display:print-comment(fn:doc($uri)/xq:xqdoc/xq:module/xq:comment/xq:description, (), $local),<br/>            &lt;ul&gt;<br/>              {<br/>              (display:print-comment(fn:doc($uri)/xq:xqdoc/xq:module/xq:comment/xq:author, "Author:", $local),<br/>              display:print-comment(fn:doc($uri)/xq:xqdoc/xq:module/xq:comment/xq:version, "Version:", $local),<br/>              display:print-comment(fn:doc($uri)/xq:xqdoc/xq:module/xq:comment/xq:since, "Since:", $local),<br/>              display:print-comment(fn:doc($uri)/xq:xqdoc/xq:module/xq:comment/xq:see, "See:", $local))<br/>              }<br/>            &lt;/ul&gt;)<br/>    else<br/>         ()<br/>   )<br/>}<br/><br/>(:~<br/> :  Construct the high-level xqDoc HTML for any global variables<br/> :  declared in the module.  In addition, cross-reference<br/> :  links will be included for the following:<br/> :  &lt;ul&gt;<br/> :  &lt;li&gt;Functions (contained in this module) that &lt;i&gt;use&lt;/i&gt; this variable&lt;/li&gt;<br/> :  &lt;li&gt;Functions (not contained in this module) that &lt;i&gt;use&lt;/i&gt; this variable&lt;/li&gt;<br/> :  &lt;/ul&gt;<br/> :  @param $uri the URI for the module<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML.<br/> :)<br/>define function display:print-variables($uri as xs:string, $local as xs:boolean) as element()* <br/>{<br/>  if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:variables/xq:variable)) then<br/>      (&lt;h4&gt;Variables&lt;/h4&gt;, <br/>       &lt;div id="variables"&gt;<br/>       {<br/>            for $v in fn:doc($uri)/xq:xqdoc/xq:variables/xq:variable<br/>            return <br/>                &lt;div&gt;<br/>                 &lt;a name="{ fn:concat("$", xs:string($v/xq:uri)) }"/&gt;<br/>                 &lt;ul class="method"&gt;<br/>                   &lt;li class="left"&gt;{ fn:concat("$", xs:string($v/xq:uri)) }&lt;/li&gt;<br/>                   &lt;li class="right"&gt;{ $v/xq:comment/xq:description/node() }&lt;/li&gt;<br/>                 &lt;/ul&gt;<br/>                 &lt;ul&gt;<br/>                 { display:print-comment($v/xq:comment/xq:since, "Since:", $local) }<br/>                 { display:print-comment($v/xq:comment/xq:see, "See:", $local) }<br/>                 &lt;/ul&gt;<br/>                 { display:print-internal-variable-references($v, $local) }<br/>                 { display:print-external-variable-references($v, $local) }<br/>                &lt;/div&gt;<br/>       }       <br/>       &lt;/div&gt;)<br/>  else<br/>    ()<br/>}<br/><br/>(:~<br/> :  Construct the high-level xqDoc HTML for any modules<br/> :  imported by the module.  <br/> :<br/> :  @param $uri the URI for the module<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML.<br/> :)<br/>define function display:print-imports($uri as xs:string, $local as xs:boolean) as element()* <br/>{<br/>  if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:imports/xq:import)) then<br/>       (&lt;h4&gt;Imported Modules&lt;/h4&gt;,<br/>        &lt;div id="imports"&gt;<br/>          {<br/>            for $v in fn:doc($uri)/xq:xqdoc/xq:imports/xq:import<br/>            return <br/>              &lt;div&gt;<br/>               &lt;ul class="method"&gt;<br/>               &lt;li class="left"&gt;<br/>               {<br/>               if (fn:exists(fn:collection($display:XQDOC_COLLECTION)/xq:xqdoc/xq:module[xq:uri = $v/xq:uri])) then<br/>                 display:build-link("get-module",<br/>                                    $local, <br/>                                    fn:base-uri(fn:collection($display:XQDOC_COLLECTION)/xq:xqdoc/xq:module[xq:uri = $v/xq:uri]),<br/>                                    display:decode-uri(xs:string($v/xq:uri)))<br/>               else<br/>                 display:decode-uri(xs:string($v/xq:uri)) <br/>               }<br/>               &lt;/li&gt;<br/>               &lt;li class="right"&gt; {$v/xq:comment/xq:description/node() }&lt;/li&gt;           <br/>               &lt;/ul&gt;<br/>               &lt;ul&gt;<br/>               { display:print-comment($v/xq:comment/xq:since, "Since:", $local) }<br/>               { display:print-comment($v/xq:comment/xq:see, "See:", $local) }<br/>               &lt;/ul&gt;<br/>              &lt;/div&gt;<br/>            }<br/>        &lt;/div&gt;)<br/>  else<br/>    ()<br/>}<br/><br/>(:~<br/> :  Construct the xqDoc HTML method summary for each function defined<br/> :  in the module.  The method summary will contain the function<br/> :  signature and the first &lt;i&gt;sentence&lt;/i&gt; of any xqDoc comments associated<br/> :  with the function.<br/> :<br/> :  @param $uri the URI for the module<br/> :  @return HTML.<br/> :)<br/>define function display:print-method-summary($uri as xs:string) as element()* <br/>{<br/>  if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:functions/xq:function)) then<br/>    (&lt;h4&gt;Function Summary&lt;/h4&gt;,<br/>     &lt;div id="methods"&gt; <br/>     &lt;a name="methods"/&gt;  <br/>        {<br/>         for $f in fn:doc($uri)/xq:xqdoc/xq:functions/xq:function<br/>         order by fn:normalize-space(xs:string($f/xq:name)) ascending<br/>         return<br/>            &lt;ul class="method"&gt;<br/>              &lt;li class="left"&gt;<br/>               &lt;a href="{fn:concat('#', fn:normalize-space(xs:string($f/xq:name)))}"&gt;{fn:normalize-space(xs:string($f/xq:name))}&lt;/a&gt;<br/>               &lt;div class="description"&gt;<br/>               {<br/>                 if (fn:exists($f/xq:comment/xq:description)) then <br/>                    if (fn:substring-before($f/xq:comment/xq:description, ".")) then<br/>                      fn:concat(fn:substring-before($f/xq:comment/xq:description, "."), ".")<br/>                    else<br/>                      xs:string($f/xq:comment/xq:description)<br/>                 else<br/>                    ()<br/>               }<br/>               &lt;/div&gt;<br/>              &lt;/li&gt;<br/>              &lt;li class="right"&gt;<br/>               {display:print-signature($f/xq:signature, fn:true())}<br/>              &lt;/li&gt;<br/>            &lt;/ul&gt;<br/>          }<br/>    &lt;/div&gt;)<br/>  else<br/>    ()<br/>}<br/><br/>(:~<br/> :  Construct the xqDoc HTML method detail for each function defined<br/> :  in the module.  The method detail will contain the function<br/> :  signature and all xqDoc comments associated with the function.  In<br/> :  addition, cross-reference links will be included for the following:<br/> :  &lt;ul&gt;<br/> :  &lt;li&gt;Functions (contained in this module) that &lt;i&gt;are used&lt;/i&gt; by this function&lt;/li&gt;<br/> :  &lt;li&gt;Functions (not contained in this module) that &lt;i&gt;are used&lt;/i&gt; by this function&lt;/li&gt;<br/> :  &lt;li&gt;Functions (contained in this module) that &lt;i&gt;use&lt;/i&gt; this function&lt;/li&gt;<br/> :  &lt;li&gt;Functions (not contained in this module) that &lt;i&gt;use&lt;/i&gt; this function&lt;/li&gt;<br/> :  &lt;li&gt;Variables (contained in this module) that &lt;i&gt;are used&lt;/i&gt; by this function&lt;/li&gt;<br/> :  &lt;li&gt;Variables (not contained in this module) that &lt;i&gt;are used&lt;/i&gt; by this function&lt;/li&gt;<br/> :  &lt;/ul&gt;<br/> :<br/> :  @param $uri the URI for the module<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML.<br/> :)<br/>define function display:print-method-detail($uri as xs:string, $local as xs:boolean) as item()* <br/>{<br/>  if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:functions/xq:function)) then<br/>    (&lt;h4&gt;Function Detail&lt;/h4&gt;,<br/>     &lt;div id="methoddetail"&gt;<br/>     {<br/>      for $f in fn:doc($uri)/xq:xqdoc/xq:functions/xq:function<br/>      order by fn:normalize-space(xs:string($f/xq:name)) ascending<br/>      return<br/>        (&lt;div id="{fn:normalize-space(xs:string($f/xq:name))}" class="methoddetail"&gt;<br/>         &lt;h5&gt;&lt;a name="{fn:normalize-space(xs:string($f/xq:name))}"/&gt;{fn:normalize-space(xs:string($f/xq:name))}&lt;/h5&gt;<br/>         &lt;ul class="method"&gt;<br/>           &lt;li class="left"&gt;<br/>           {<br/>             if (fn:exists($f/xq:body)) then<br/><br/>              display:build-link("get-code",<br/>                                 $local, <br/>                                 ($uri,fn:normalize-space(xs:string($f/xq:name))),<br/>                                 fn:normalize-space(xs:string($f/xq:name)))<br/>             else<br/>              ()<br/>           }<br/>           &lt;/li&gt;<br/>           &lt;li class="right"&gt;     <br/>              { display:print-signature($f/xq:signature, fn:false()) }<br/>           &lt;/li&gt;<br/>         &lt;/ul&gt;<br/>	   {display:print-detail-comment($f/xq:comment/xq:description, (), $local)}<br/>         &lt;ul&gt;<br/>         {<br/>           (display:print-detail-comment($f/xq:comment/xq:param, "Parameters:", $local),<br/>            display:print-detail-comment($f/xq:comment/xq:return, "Return:", $local),<br/>            display:print-detail-comment($f/xq:comment/xq:error, "Errors:", $local),<br/>            display:print-detail-comment($f/xq:comment/xq:since, "Since:", $local),<br/>            display:print-detail-comment($f/xq:comment/xq:see, "See:", $local),<br/>            display:print-detail-comment($f/xq:comment/xq:deprecated, "Deprecated:", $local) )<br/>         }<br/>         &lt;/ul&gt;<br/>         {<br/>         display:print-external-functions-invoked($f, $local),   <br/>         display:print-external-functions-invoked-by($f, $local),      <br/>         display:print-internal-functions-invoked($f, $local),    <br/>         display:print-internal-functions-invoked-by($f, $local),  <br/>         display:print-internal-variables-referenced($f, $local),<br/>         display:print-external-variables-referenced($f, $local)<br/>         }<br/>         &lt;/div&gt;,  "&amp;#160;")<br/>    }<br/>    &lt;/div&gt;, "&amp;#160;")<br/>  else<br/>    ()    <br/>}<br/><br/>(:~<br/> :  Construct the xqDoc HTML for the function signature.<br/> :<br/> :  @param $sigs the signatures associated with the current function.  Although only one<br/> :               signature is allowed for user-defined functions, more than one signature<br/> :               is required to support other 'modules' such as XPath F &amp;amp; O.<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return String containing the marked up function signature.<br/> :)<br/>define function display:print-signature($sigs as xs:string*, $local as xs:boolean) as item()*<br/>{<br/>  for $sig at $cnt in $sigs<br/>  return<br/>  (let $params := fn:substring-after($sig, "(")<br/>   let $tokens := fn:tokenize($params, ",")<br/>   let $count := fn:count($tokens)<br/>   return<br/>     (if ($cnt &gt; 1) then <br/>	  ("OR", &lt;br/&gt;,&lt;br/&gt;)<br/>      else<br/>        (),<br/>      for $token at $index in $tokens<br/>      return<br/>       (if ($index = 1) then<br/>          xs:string("(")<br/>        else<br/>          (),<br/>        if ($index = 1) then<br/>	    fn:normalize-space($token)<br/>        else<br/>          ("&amp;#160;", fn:normalize-space($token)),<br/>        if ($index &lt; $count) then<br/>          xs:string(",")<br/>        else<br/>          (),<br/>        &lt;br/&gt;)), <br/>  &lt;br/&gt;)<br/>}<br/><br/>(:~<br/> :  Construct the xqDoc HTML for the specified xqDoc comment.  The following<br/> :  xqDoc comment values are supported.<br/> :  &lt;ul&gt;<br/> :  &lt;li&gt;author&lt;/li&gt;<br/> :  &lt;li&gt;version&lt;/li&gt;<br/> :  &lt;li&gt;param&lt;/li&gt;<br/> :  &lt;li&gt;return&lt;/li&gt;<br/> :  &lt;li&gt;error&lt;/li&gt;<br/> :  &lt;li&gt;deprecated&lt;/li&gt;<br/> :  &lt;li&gt;see&lt;/li&gt;<br/> :  &lt;li&gt;since&lt;/li&gt;<br/> :  &lt;li&gt;&lt;i&gt;empty&lt;/i&gt; which indicates a &lt;i&gt;description&lt;/i&gt;&lt;/li&gt;<br/> :  &lt;/ul&gt;<br/> :<br/> :  @param $comment the xqDoc comment element associated with a function<br/> :  @param $name the xqDoc comment name to process (i.e. author, version, etc.)<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML<br/> :)<br/>define function display:print-comment($comment as element()*, $name as xs:string?, $local as xs:boolean) as element()* <br/>{<br/>  if (fn:exists($comment)) then<br/>     for $i in $comment<br/>       return           <br/>             if (fn:not(fn:exists($name))) then <br/>               &lt;p&gt;{$i/node()}&lt;/p&gt;     <br/>             else if ($name = "See:") then<br/>               &lt;li&gt;&lt;strong&gt;{fn:concat($name, "&amp;#160;")}&lt;/strong&gt;{display:print-comment-see($i, $local)}&lt;/li&gt;<br/>             else<br/>               &lt;li&gt;&lt;strong&gt;{fn:concat($name, "&amp;#160;")}&lt;/strong&gt;{$i/node()}&lt;/li&gt;<br/>  else<br/>    ()<br/>}<br/><br/>(:~<br/> :  Construct the &lt;i&gt;detailed&lt;/i&gt; xqDoc HTML for the specified xqDoc comment.  <br/> :  Detailed essentially implies the xqDoc comments for the method detail. The following<br/> :  xqDoc comment values are supported.<br/> :  &lt;ul&gt;<br/> :  &lt;li&gt;author&lt;/li&gt;<br/> :  &lt;li&gt;version&lt;/li&gt;<br/> :  &lt;li&gt;param&lt;/li&gt;<br/> :  &lt;li&gt;return&lt;/li&gt;<br/> :  &lt;li&gt;error&lt;/li&gt;<br/> :  &lt;li&gt;deprecated&lt;/li&gt;<br/> :  &lt;li&gt;see&lt;/li&gt;<br/> :  &lt;li&gt;since&lt;/li&gt;<br/> :  &lt;li&gt;&lt;i&gt;empty&lt;/i&gt; which indicates a &lt;i&gt;description&lt;/i&gt;&lt;/li&gt;<br/> :  &lt;/ul&gt;<br/> :<br/> :  @param $comment the xqDoc comment element associated with a function<br/> :  @param $name the xqDoc comment name to process (i.e. author, version, etc.)<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML<br/> :)<br/><br/>define function display:print-detail-comment($comment as element()*, $name as xs:string?, $local as xs:boolean) as element()*<br/>{<br/>  if (fn:exists($comment)) then<br/>    if (fn:exists($name)) then       <br/>      (&lt;li&gt;{$name}&lt;/li&gt;,<br/>       &lt;ul&gt;<br/>          {<br/>            for $i in $comment<br/>            return<br/>              if ($name = "Parameters:") then<br/>                &lt;li&gt;{display:print-comment-param($i)}&lt;/li&gt;             <br/>              else if ($name = "See:") then<br/>                &lt;li&gt;{display:print-comment-see($i, $local)}&lt;/li&gt;<br/>              else<br/>                &lt;li&gt;{$i/node()}&lt;/li&gt;<br/>          }<br/>      &lt;/ul&gt;) <br/>    else<br/>      &lt;p&gt;{$comment/node()}&lt;/p&gt; <br/>  else<br/>    ()  <br/>}<br/><br/>(:~<br/> :  Construct the xqDoc HTML for the specified xqDoc &lt;i&gt;param&lt;/i&gt; comment element.  <br/> :<br/> :  @param $entry the xqDoc &lt;i&gt;param&lt;/i&gt; comment element associated with a function<br/> :  @return HTML<br/> :)<br/>define function display:print-comment-param($entry as element()) as item()* <br/>{<br/>    let $tmp := xs:string(($entry/node())[1])<br/>    let $bef :=  fn:substring-before(fn:normalize-space($tmp), " ")<br/>    let $aft :=  fn:substring-after(fn:normalize-space($tmp), " ")<br/>    return<br/>       (if (fn:string-length($bef) &gt; 0) then<br/>		fn:concat($bef, " - ", $aft)<br/>	  else<br/>		$tmp,<br/>	  (for $x at $y in $entry/node()<br/>         return<br/>           if ($y &gt; 1) then<br/>               (" ", $x, " ")<br/>           else<br/>               ()),<br/>         &lt;br/&gt;)<br/>}<br/><br/>(:~<br/> :  Construct the xqDoc HTML for the specified xqDoc &lt;i&gt;see&lt;/i&gt; comment element. <br/> :  If the comment is a URI that exists for a module contained within<br/> :  xqDoc, build a link to this module (and optionally method or variable<br/> :  name.  If the comment is a 'http://' URL, then build a link to the URL.  If the<br/> :  comment is simply text, return the text.  With version 1.1, it is now also<br/> :  possible to specify the visible display name for the link.  This is accomplished<br/> :  by specifying an option second semi-colon followed by the link name.  So, the<br/> :  format for the parameter would be as follows:<br/> :  &lt;p/&gt;<br/> :<br/> :    a mandatory uri (or text) ';' an optional variable or method name ';' an optional link name<br/> :<br/> :  @param $entry the xqDoc param comment element associated with a function<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML<br/> :)<br/><br/>define function display:print-comment-see($entry as element(), $local as xs:boolean) as item()* <br/>{<br/>  let $tmp := fn:normalize-space(xs:string($entry))<br/>  let $tokens := fn:tokenize($tmp, ";")<br/>  return<br/><br/>  if (fn:count($tokens) = 1) then<br/><br/>    if (fn:not(fn:contains($tokens,"#")) and fn:exists(fn:doc($tokens))) then<br/><br/>        display:build-link("get-module",<br/>                           $local,<br/>                           $tokens,<br/>                           $tmp)<br/><br/>    else if (fn:starts-with($tokens, "http")) then<br/><br/>        &lt;a href="{$tokens}"&gt;{$tokens}&lt;/a&gt;<br/><br/>    else<br/><br/>        $entry/node()<br/><br/>  else if (fn:count($tokens) = 2) then<br/><br/>    if (fn:not(fn:contains($tokens[1],"#")) and fn:exists(fn:doc($tokens[1])//xq:functions/xq:function[xq:name = fn:normalize-space($tokens[2])])) then<br/><br/>        display:build-link("get-module",<br/>                           $local,<br/>                           $tokens,<br/>                           $tmp)<br/><br/>    else<br/><br/>      $entry/node()<br/><br/>  else if (fn:count($tokens) = 3) then<br/><br/>    if (fn:string-length($tokens[2]) = 0 and fn:not(fn:contains($tokens[1],"#")) and fn:exists(fn:doc($tokens[1]))) then<br/><br/>        display:build-link("get-module",<br/>                           $local,<br/>                           $tokens,<br/>                           $tokens[3])<br/><br/>    else if (fn:string-length($tokens[2]) = 0 and fn:starts-with($tokens[1], "http")) then<br/><br/>        &lt;a href="{$tokens[1]}"&gt;{$tokens[3]}&lt;/a&gt;<br/><br/>    else if (fn:string-length($tokens[2]) &gt; 0 and fn:not(fn:contains($tokens[1],"#")) and fn:exists(fn:doc($tokens[1])//xq:functions/xq:function[xq:name = fn:normalize-space($tokens[2])])) then<br/><br/>        display:build-link("get-module",<br/>                           $local,<br/>                           $tokens,<br/>                           $tokens[3])<br/><br/>    else<br/><br/>      $entry/node()<br/><br/>  else<br/><br/>    $entry/node()<br/>}<br/><br/>(:~<br/> :  Construct the information to identify those functions (contained in<br/> :  other modules) that are &lt;i&gt;used by&lt;/i&gt; the current function.  If that <br/> :  module exists in xqDoc, construct a link to the module and function.<br/> :  If that module does not exist in xqDoc, simply identify the <br/> :  module and function name.<br/> :<br/> :  @param $function the current function<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML<br/> :)<br/>define function display:print-external-functions-invoked($function as element(), $local as xs:boolean) as element()*<br/>{<br/>  if (fn:exists($function/xq:invoked[xq:uri != display:module-uri($function)])) then<br/>     &lt;div class="methoddetail"&gt;<br/>     &lt;h6&gt;External Functions that are used by this Function&lt;/h6&gt;<br/>     &lt;table class="inexternal"&gt;<br/>       &lt;tr&gt;<br/>        &lt;th align="left"&gt;Module URI&lt;/th&gt;<br/>        &lt;th align="left"&gt;Function Name&lt;/th&gt;<br/>       &lt;/tr&gt;<br/>       {<br/>       let $uris := for $x in fn:distinct-values($function/xq:invoked/xq:uri)<br/>                    where $x != display:module-uri($function)<br/>                    order by xs:string($x)<br/>                    return xs:string($x)<br/>       for $uri in $uris<br/>       let $names := for $y in $function/xq:invoked[xq:uri=$uri]<br/>                     order by xs:string($y/xq:name)<br/>                     return xs:string($y/xq:name)<br/>       for $name at $i in $names<br/>       return<br/>         if ($i = 1) then<br/>		(&lt;tr&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;/tr&gt;,<br/>            &lt;tr&gt;<br/>             &lt;td rowspan="{fn:count($names)}"&gt;{display:decode-uri($uri)}&lt;/td&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:functions/xq:function[xq:name = $name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, $name),<br/>                                          $name)<br/>                     }<br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{$name}&lt;/td&gt;<br/>             }<br/>           &lt;/tr&gt;)<br/>         else<br/>           &lt;tr&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:functions/xq:function[xq:name = $name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, $name),<br/>                                          $name)<br/>                     }                   <br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{$name}&lt;/td&gt;<br/>             }<br/>           &lt;/tr&gt;<br/>      }<br/>    &lt;/table&gt;<br/>   &lt;/div&gt;<br/><br/>  else<br/>    ()<br/>}<br/><br/>(:~<br/> :  Construct the information to identify those functions (contained in<br/> :  other modules) that &lt;i&gt;use&lt;/i&gt; the current function.  If that <br/> :  module exists in xqDoc, construct a link to the module and function.<br/> :  If that module does not exist in xqDoc, simply identify the <br/> :  module and function name.<br/> :<br/> :  @param $function the current function<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML<br/> :)<br/>define function display:print-external-functions-invoked-by($function as element(), $local as xs:boolean) as element()*<br/>{<br/>  if (fn:exists(fn:collection($display:XQDOC_COLLECTION)/xq:xqdoc/xq:functions/xq:function/xq:invoked[display:module-uri(.) != display:module-uri($function) and xq:uri=display:module-uri($function) and xq:name=xs:string($function/xq:name)])) then<br/>    &lt;div class="methoddetail"&gt;<br/>     &lt;h6&gt;External Functions that invoke this Function&lt;/h6&gt;<br/>     &lt;table class="inexternal"&gt;<br/>       &lt;tr&gt;<br/>        &lt;th align="left"&gt;Module URI&lt;/th&gt;<br/>        &lt;th align="left"&gt;Function Name&lt;/th&gt;<br/>       &lt;/tr&gt;<br/>       {<br/>        let $list := for $x in fn:collection($display:XQDOC_COLLECTION)/xq:xqdoc/xq:functions/xq:function/xq:invoked[xq:uri=display:module-uri($function) and xq:name=xs:string($function/xq:name)]<br/>                     return $x<br/>        let $uris := fn:distinct-values(for $y in $list<br/>                                     where display:module-uri($y) != display:module-uri($function)<br/>                                     order by display:module-uri($y)<br/>                                     return<br/>                                       display:module-uri($y))<br/>        for $uri in $uris<br/>        let $entries := for $entry in $list<br/>                        where display:module-uri($entry)=$uri<br/>                        order by $entry/../xq:name<br/>                        return $entry<br/>        for $entry at $i in $entries<br/>        return <br/>           if ($i = 1) then<br/>		(&lt;tr&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;/tr&gt;,<br/>            &lt;tr&gt;<br/>             &lt;td rowspan="{fn:count($entries)}"&gt;{display:decode-uri($uri)}&lt;/td&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:functions/xq:function[xq:name = $entry/../xq:name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, xs:string($entry/../xq:name)),<br/>                                          xs:string($entry/../xq:name))<br/>                     }<br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{xs:string($entry/../xq:name)}&lt;/td&gt;<br/>             }<br/>            &lt;/tr&gt;)<br/>           else<br/>            &lt;tr&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:functions/xq:function[xq:name = $entry/../xq:name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, xs:string($entry/../xq:name)),<br/>                                          xs:string($entry/../xq:name))<br/>                     }<br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{xs:string($entry/../xq:name)}&lt;/td&gt;<br/>             }<br/>            &lt;/tr&gt;<br/>        }	  <br/>        &lt;/table&gt;<br/>       &lt;/div&gt;<br/>   else<br/>    ()<br/>}<br/><br/>(:~<br/> :  Construct the information to identify those functions (contained in the module<br/> :  for the current function) that are &lt;i&gt;used by&lt;/i&gt; the current function.  <br/> :  Construct a link to the module and function.<br/> :<br/> :  @param $function the current function<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML<br/> :)<br/>define function display:print-internal-functions-invoked($function as element(), $local as xs:boolean) as element()*<br/>{<br/>  if (fn:exists($function/xq:invoked[xq:uri = display:module-uri($function)])) then<br/>    &lt;div class="methoddetail"&gt;<br/>     &lt;h6&gt;Internal Functions used by this Function&lt;/h6&gt;<br/>     &lt;table class="inexternal"&gt;<br/>       &lt;tr&gt;<br/>        &lt;th align="left"&gt;Module URI&lt;/th&gt;<br/>        &lt;th align="left"&gt;Function Name&lt;/th&gt;<br/>       &lt;/tr&gt;<br/>      {<br/>       let $uris := for $x in fn:distinct-values($function/xq:invoked/xq:uri)<br/>                    where $x = display:module-uri($function)<br/>                    order by xs:string($x)<br/>                    return xs:string($x)<br/>       for $uri in $uris<br/>       let $names := for $y in $function/xq:invoked[xq:uri=$uri]<br/>                     order by xs:string($y/xq:name)<br/>                     return xs:string($y/xq:name)<br/>       for $name at $i in $names<br/>       return<br/>         if ($i = 1) then<br/>		(&lt;tr&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;/tr&gt;,<br/>            &lt;tr&gt;<br/>             &lt;td rowspan="{fn:count($names)}"&gt;{display:decode-uri($uri)}&lt;/td&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:functions/xq:function[xq:name = $name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, $name),<br/>                                          $name)<br/>                     }<br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{$name}&lt;/td&gt;<br/>             }<br/>           &lt;/tr&gt;)<br/>         else<br/>           &lt;tr&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:functions/xq:function[xq:name = $name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, $name),<br/>                                          $name)<br/>                     }<br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{$name}&lt;/td&gt;<br/>             }<br/>           &lt;/tr&gt;<br/>      }<br/>    &lt;/table&gt;<br/>   &lt;/div&gt;<br/><br/>  else<br/>    ()<br/>}<br/><br/>(:~<br/> :  Construct the information to identify those functions (contained in the module<br/> :  for the current function) that &lt;i&gt;use&lt;/i&gt; the current function.  <br/> :  Construct a link to the module and function.<br/> :<br/> :  @param $function the current function<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML<br/> :)<br/>define function display:print-internal-functions-invoked-by($function as element(), $local as xs:boolean) as element()*<br/>{<br/>  if (fn:exists(fn:collection($display:XQDOC_COLLECTION)/xq:xqdoc/xq:functions/xq:function/xq:invoked[display:module-uri(.) = display:module-uri($function) and xq:uri=display:module-uri($function) and xq:name=xs:string($function/xq:name)])) then<br/>    &lt;div class="methoddetail"&gt;<br/>     &lt;h6&gt;Internal Functions that invoke this Function&lt;/h6&gt;<br/>     &lt;table class="inexternal"&gt;<br/>       &lt;tr&gt;<br/>        &lt;th align="left"&gt;Module URI&lt;/th&gt;<br/>        &lt;th align="left"&gt;Function Name&lt;/th&gt;<br/>       &lt;/tr&gt;<br/>       {<br/>        let $list := for $x in fn:collection($display:XQDOC_COLLECTION)/xq:xqdoc/xq:functions/xq:function/xq:invoked[xq:uri=display:module-uri($function) and xq:name=xs:string($function/xq:name)]<br/>                     return $x<br/>        let $uris := fn:distinct-values(for $y in $list<br/>                                     where display:module-uri($y) = display:module-uri($function)<br/>                                     order by display:module-uri($y)<br/>                                     return<br/>                                       display:module-uri($y))<br/>        for $uri in $uris<br/>        let $entries := for $entry in $list<br/>                        where display:module-uri($entry)=$uri<br/>                        order by $entry/../xq:name<br/>                        return $entry<br/>        for $entry at $i in $entries<br/>        return <br/>           if ($i = 1) then<br/>		(&lt;tr&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;/tr&gt;,<br/>            &lt;tr&gt;<br/>             &lt;td rowspan="{fn:count($entries)}"&gt;{display:decode-uri($uri)}&lt;/td&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:functions/xq:function[xq:name = $entry/../xq:name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, xs:string($entry/../xq:name)),<br/>                                          xs:string($entry/../xq:name))<br/>                     }<br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{xs:string($entry/../xq:name)}&lt;/td&gt;<br/>             }<br/>            &lt;/tr&gt;)<br/>           else<br/>            &lt;tr&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:functions/xq:function[xq:name = $entry/../xq:name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, xs:string($entry/../xq:name)),<br/>                                          xs:string($entry/../xq:name))<br/>                     }<br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{xs:string($entry/../xq:name)}&lt;/td&gt;<br/>             }<br/>            &lt;/tr&gt;<br/>        }<br/>        &lt;/table&gt;<br/>       &lt;/div&gt;<br/>   else<br/>    ()<br/>}<br/><br/>(:~<br/> :  Construct the information to identify those functions (defined in other modules<br/> :  from the current variable) that &lt;i&gt;used&lt;/i&gt; the current variable.  If that <br/> :  module exists in xqDoc, construct a link to the module and function.<br/> :  If that module does not exist in xqDoc, simply identify the <br/> :  module and function name.<br/> :<br/> :  @param $variable the current variable<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML<br/> :)<br/>define function display:print-external-variable-references($variable as element(), $local as xs:boolean) as element()*<br/>{<br/>  if (fn:exists(fn:collection($display:XQDOC_COLLECTION)/xq:xqdoc/xq:functions/xq:function/xq:ref-variable[display:module-uri(.) != display:module-uri($variable) and xq:uri=display:module-uri($variable) and xq:name=xs:string($variable/xq:uri)])) then<br/>    &lt;div class="methoddetail"&gt;<br/>     &lt;h6&gt;External Functions that reference this Variable&lt;/h6&gt;<br/>     &lt;table class="inexternal"&gt;<br/>       &lt;tr&gt;<br/>        &lt;th align="left"&gt;Module URI&lt;/th&gt;<br/>        &lt;th align="left"&gt;Function Name&lt;/th&gt;<br/>       &lt;/tr&gt;<br/>       {<br/>        let $list := for $x in fn:collection($display:XQDOC_COLLECTION)/xq:xqdoc/xq:functions/xq:function/xq:ref-variable[xq:uri=display:module-uri($variable) and xq:name=xs:string($variable/xq:uri)]<br/>                     return $x<br/>        let $uris := fn:distinct-values(for $y in $list<br/>                                     where display:module-uri($y) != display:module-uri($variable)<br/>                                     order by display:module-uri($y)<br/>                                     return<br/>                                       display:module-uri($y))<br/>        for $uri in $uris<br/>        let $entries := for $entry in $list<br/>                        where display:module-uri($entry)=$uri<br/>                        order by $entry/../xq:name<br/>                        return $entry<br/>        for $entry at $i in $entries<br/>        return <br/>           if ($i = 1) then<br/>		(&lt;tr&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;/tr&gt;,<br/>            &lt;tr&gt;<br/>             &lt;td rowspan="{fn:count($entries)}"&gt;{display:decode-uri($uri)}&lt;/td&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:functions/xq:function[xq:name = $entry/../xq:name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, xs:string($entry/../xq:name)),<br/>                                          xs:string($entry/../xq:name))<br/>                     }<br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{xs:string($entry/../xq:name)}&lt;/td&gt;<br/>             }<br/>            &lt;/tr&gt;)<br/>           else<br/>            &lt;tr&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:functions/xq:function[xq:name = $entry/../xq:name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, xs:string($entry/../xq:name)),<br/>                                          xs:string($entry/../xq:name))<br/>                     }<br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{xs:string($entry/../xq:name)}&lt;/td&gt;<br/>             }<br/>            &lt;/tr&gt;<br/>        }<br/>        &lt;/table&gt;<br/>       &lt;/div&gt;<br/>   else<br/>    ()<br/>}<br/><br/>(:~<br/> :  Construct the information to identify those functions (defined in the module<br/> :  for the current variable) that &lt;i&gt;use&lt;/i&gt; the current variable.  <br/> :  Construct a link to the module and function.<br/> :<br/> :  @param $variable the current variable<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML<br/> :)<br/>define function display:print-internal-variable-references($variable as element(), $local as xs:boolean) as element()*<br/>{<br/>  if (fn:exists(fn:collection($display:XQDOC_COLLECTION)/xq:xqdoc/xq:functions/xq:function/xq:ref-variable[display:module-uri(.) = display:module-uri($variable) and xq:uri=display:module-uri($variable) and xq:name=xs:string($variable/xq:uri)])) then<br/>    &lt;div class="methoddetail"&gt;<br/>     &lt;h6&gt;Internal Functions that reference this Variable&lt;/h6&gt;<br/>     &lt;table class="inexternal"&gt;<br/>       &lt;tr&gt;<br/>        &lt;th align="left"&gt;Module URI&lt;/th&gt;<br/>        &lt;th align="left"&gt;Function Name&lt;/th&gt;<br/>       &lt;/tr&gt;<br/>       {<br/>        let $list := for $x in fn:collection($display:XQDOC_COLLECTION)/xq:xqdoc/xq:functions/xq:function/xq:ref-variable[xq:uri=display:module-uri($variable) and xq:name=xs:string($variable/xq:uri)]<br/>                     return $x<br/>        let $uris := fn:distinct-values(for $y in $list<br/>                                     where display:module-uri($y) = display:module-uri($variable)<br/>                                     order by display:module-uri($y)<br/>                                     return<br/>                                       display:module-uri($y))<br/>        for $uri in $uris<br/>        let $entries := for $entry in $list<br/>                        where display:module-uri($entry)=$uri<br/>                        order by $entry/../xq:name<br/>                        return $entry<br/>        for $entry at $i in $entries<br/>        return <br/>           if ($i = 1) then<br/>		(&lt;tr&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;/tr&gt;,<br/>            &lt;tr&gt;<br/>             &lt;td rowspan="{fn:count($entries)}"&gt;{display:decode-uri($uri)}&lt;/td&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:functions/xq:function[xq:name = $entry/../xq:name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, xs:string($entry/../xq:name)),<br/>                                          xs:string($entry/../xq:name))<br/>                     }<br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{xs:string($entry/../xq:name)}&lt;/td&gt;<br/>             }<br/>            &lt;/tr&gt;)<br/>           else<br/>            &lt;tr&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:functions/xq:function[xq:name = $entry/../xq:name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, xs:string($entry/../xq:name)),<br/>                                          xs:string($entry/../xq:name))<br/>                     }<br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{xs:string($entry/../xq:name)}&lt;/td&gt;<br/>             }<br/>            &lt;/tr&gt;<br/>        }<br/>        &lt;/table&gt;<br/>       &lt;/div&gt;<br/>   else<br/>    ()<br/>}<br/><br/>(:~<br/> :  Construct the information to identify those functions (defined in other modules<br/> :  from the current variable) that &lt;i&gt;use&lt;/i&gt; the current variable.  If that <br/> :  module exists in xqDoc, construct a link to the module and function.<br/> :  If that module does not exist in xqDoc, simply identify the <br/> :  module and function name.<br/> :<br/> :  @param $variable the current variable<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML<br/> :)<br/>define function display:print-external-variables-referenced($variable as element(), $local as xs:boolean) as element()*<br/>{<br/>  if (fn:exists($variable/xq:ref-variable[xq:uri != display:module-uri($variable)])) then<br/>    &lt;div class="methoddetail"&gt;<br/>     &lt;h6&gt;External Variables used by this Function&lt;/h6&gt;<br/>     &lt;table class="inexternal"&gt;<br/>       &lt;tr&gt;<br/>        &lt;th align="left"&gt;Module URI&lt;/th&gt;<br/>        &lt;th align="left"&gt;Variable Name&lt;/th&gt;<br/>       &lt;/tr&gt;<br/>      {<br/>       let $uris := for $x in fn:distinct-values($variable/xq:ref-variable/xq:uri)<br/>                    where $x != display:module-uri($variable)<br/>                    order by xs:string($x)<br/>                    return xs:string($x)<br/>       for $uri in $uris<br/>       let $names := for $y in $variable/xq:ref-variable[xq:uri=$uri]<br/>                     order by xs:string($y/xq:name)<br/>                     return xs:string($y/xq:name)<br/>       for $name at $i in $names<br/>       return<br/>         if ($i = 1) then<br/>		(&lt;tr&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;/tr&gt;,<br/>            &lt;tr&gt;<br/>             &lt;td rowspan="{fn:count($names)}"&gt;{display:decode-uri($uri)}&lt;/td&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:variables/xq:variable[xq:uri = $name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, fn:concat("$",$name)),<br/>                                          fn:concat("$",$name))<br/>                     }<br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{fn:concat("$",$name)}&lt;/td&gt;<br/>             }<br/>           &lt;/tr&gt;)<br/>         else<br/>           &lt;tr&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:variables/xq:variable[xq:uri = $name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, fn:concat("$",$name)),<br/>                                          fn:concat("$",$name))<br/>                     }<br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{fn:concat("$",$name)}&lt;/td&gt;<br/>             }<br/>           &lt;/tr&gt;<br/>      }<br/>    &lt;/table&gt;<br/>   &lt;/div&gt;<br/><br/>  else<br/>    ()<br/>}<br/><br/>(:~<br/> :  Construct the information to identify those functions (defined in the module<br/> :  for the current variable) that &lt;i&gt;use&lt;/i&gt; the current variable.  <br/> :  Construct a link to the module and function.<br/> :<br/> :  @param $variable the current variable<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML<br/> :)<br/>define function display:print-internal-variables-referenced($variable as element(), $local as xs:boolean) as element()*<br/>{<br/>  if (fn:exists($variable/xq:ref-variable[xq:uri = display:module-uri($variable)])) then<br/>    &lt;div class="methoddetail"&gt;<br/>     &lt;h6&gt;Internal Variables used by this Function&lt;/h6&gt;<br/>     &lt;table class="inexternal"&gt;<br/>       &lt;tr&gt;<br/>        &lt;th align="left"&gt;Module URI&lt;/th&gt;<br/>        &lt;th align="left"&gt;Variable Name&lt;/th&gt;<br/>       &lt;/tr&gt;<br/>      {<br/>       let $uris := for $x in fn:distinct-values($variable/xq:ref-variable/xq:uri)<br/>                    where $x = display:module-uri($variable)<br/>                    order by xs:string($x)<br/>                    return xs:string($x)<br/>       for $uri in $uris<br/>       let $names := for $y in $variable/xq:ref-variable[xq:uri=$uri]<br/>                     order by xs:string($y/xq:name)<br/>                     return xs:string($y/xq:name)<br/>       for $name at $i in $names<br/>       return<br/>         if ($i = 1) then<br/>		(&lt;tr&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;td&gt;{"&amp;#160;"}&lt;/td&gt;&lt;/tr&gt;,<br/>            &lt;tr&gt;<br/>             &lt;td rowspan="{fn:count($names)}"&gt;{display:decode-uri($uri)}&lt;/td&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:variables/xq:variable[xq:uri = $name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, fn:concat("$",$name)),<br/>                                          fn:concat("$",$name))<br/>                     }<br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{fn:concat("$",$name)}&lt;/td&gt;<br/>             }<br/>           &lt;/tr&gt;)<br/>         else<br/>           &lt;tr&gt;<br/>             {<br/>               if (fn:exists(fn:doc($uri)/xq:xqdoc/xq:variables/xq:variable[xq:uri = $name])) then<br/>                 &lt;td&gt;<br/>                     {<br/>                       display:build-link("get-module",<br/>                                          $local, <br/>                                          ($uri, fn:concat("$",$name)),<br/>                                          fn:concat("$",$name))<br/>                     }<br/>                 &lt;/td&gt;<br/>               else<br/>                 &lt;td&gt;{fn:concat("$",$name)}&lt;/td&gt;<br/>             }<br/>           &lt;/tr&gt;<br/>      }<br/>    &lt;/table&gt;<br/>   &lt;/div&gt;<br/><br/>  else<br/>    ()<br/>}<br/><br/>(:~<br/> : Decode the uri.  This routine is needed for some XML databases that<br/> : have problems with specific characters contained in a document URI.<br/> : This routine makes the URI more human readable ... by removing the<br/> : encoding.  Currently, the only character encoded is a "/".  Other<br/> : characters could easily be added.  However, they would also need to<br/> : be specified in the xqDoc conversion package (XQDocContext).<br/> :<br/> : @param $uri the string to be decoded<br/> : @return the decoded string<br/> :)<br/>define function display:decode-uri($uri as xs:string) as xs:string<br/>{<br/>  fn:replace($uri, "~2F", "/")<br/>}<br/><br/>(:~<br/> : Find the module uri for the associated element.  This routine is needed <br/> : since we can't rely soley on base-uri().  Instead, the xqDoc XML URI is<br/> : contained in the XML of the document (the xqDoc module section).<br/> :<br/> : @param $e the element (i.e. function or variable) that we want to find the module uri<br/> : @return the module URI associated with the element<br/> :)<br/>define function display:module-uri($e as element()) as xs:string<br/>{<br/>  xs:string($e/ancestor::xq:xqdoc/xq:module/xq:uri)<br/>}<br/><br/>(:~<br/> :  Construct the fotter information for the current module.<br/> :  The footer will contain the version of the xqDoc conversion program<br/> :  used to generate the xqDoc XML stored in the XML database and the<br/> :  time when the XML was created.  If the xqDoc conversion program was not<br/> :  used (i.e. XPath F &amp;amp; O) then this information will be marked as N/A.<br/> :<br/> :  @param $uri the current module uri<br/> :  @return HTML<br/> :)<br/>define function display:print-footer($uri as xs:string) as element()*<br/>{<br/><br/>&lt;div align="left"&gt;<br/>     &lt;i&gt;Created by xqDoc version {xs:string(fn:doc($uri)/xq:xqdoc/xq:control/xq:version) } on {xs:string(fn:doc($uri)/xq:xqdoc/xq:control/xq:date) }&lt;/i&gt;<br/>&lt;/div&gt;<br/>}<br/><br/>(:~<br/> :  Construct the HTML for the xqDoc home page.  This will include the welcome<br/> :  text and the list of modules available in xqDoc.<br/> :<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML<br/> :)<br/>define function display:get-default-html($local as xs:boolean) as element()<br/>{<br/>  &lt;html xml:space="preserve"&gt;<br/>    &lt;head&gt;<br/>      &lt;title&gt;xqDoc -- Module List&lt;/title&gt;<br/>      { display:get-stylesheet() }<br/>    &lt;/head&gt;<br/>    &lt;body&gt;<br/>    { display:print-intro($local) }<br/>    { display:print-modules($local) }<br/>    &lt;/body&gt;<br/>  &lt;/html&gt;<br/>}<br/><br/>(:~<br/> :  Construct the HTML for a xqDoc module page.  <br/> :<br/> :  @param $module the module uri<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML<br/> :)<br/>define function display:get-module-html($module as xs:string, $local as xs:boolean) as element()<br/>{<br/>  &lt;html xml:space="preserve"&gt;<br/>    &lt;head&gt;<br/>      &lt;title&gt;xqDoc -- Module&lt;/title&gt;<br/>      &lt;script language="JavaScript"&gt;<br/>      &lt;!--<br/>        function popUp(URL) {<br/>                 day = new Date();<br/>                 id = day.getTime();<br/>                 eval("page = window.open(URL, 'xqdoccode', 'toolbar=0,scrollbars=1,location=0,statusbar=0,menubar=0,resizable=1,width=600,height=400,left = 412,top = 334');")<br/>                 page.focus();<br/>        }<br/>      --&gt;<br/>      &lt;/script&gt;<br/>      { display:get-stylesheet() }<br/>    &lt;/head&gt;<br/>    &lt;body&gt;<br/>    { display:print-module-intro($local) }<br/>    { display:print-module-control($module, $local) }<br/>    &lt;/body&gt;<br/>  &lt;/html&gt;<br/>}<br/><br/>(:~<br/> :  Construct a link.  Based on the parameters, the link will be built<br/> :  for the static (off-line viewing mode of xqDoc) or the dynamic viewing<br/> :  mode of xqDoc.   The parameters will also indicate which link to construct,<br/> :  supply the appropriate paramters for the link, and assign a name for the link.<br/> :<br/> :  @param $type the type of link to construct.  The link can be for the xqDoc home<br/> :               page, the module page for a particular module, or for the<br/> :               XQuery code for a specific function.<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @param $parms the parameters associated with the link &lt;i&gt;$type&lt;/i&gt;<br/> :  @param $name the name to assign for the link<br/> :  @return HTML<br/> :)<br/>define function display:build-link($type as xs:string, $local as xs:boolean, $parms as xs:string*, $name as xs:string?) as element()?<br/>{<br/>  if ($type = "default") then<br/><br/>    if ($local = fn:true()) then<br/>      &lt;a href="default.html"&gt;<br/>         &lt;h1&gt;xqDoc Home&lt;/h1&gt;<br/>      &lt;/a&gt;<br/><br/>    else<br/>      &lt;a href="default.xqy"&gt;<br/>         xqDoc Home<br/>      &lt;/a&gt;<br/><br/>  else if ($type = "get-module") then<br/><br/>    if ($local = fn:true()) then<br/>      &lt;a href="{fn:concat('xqdoc-file-', xs:string(fn:index-of(display:get-module-uris(), $parms[1])), '.html',<br/>         if (fn:exists($parms[2])) then<br/>           fn:concat('#', $parms[2])<br/>         else<br/>           ()<br/>         )}"&gt;<br/>        { $name }<br/>      &lt;/a&gt;<br/><br/>    else<br/>      &lt;a href="{fn:concat('get-module.xqy?module=', $parms[1],<br/>         if (fn:exists($parms[2])) then<br/>           fn:concat('#', $parms[2])<br/>         else<br/>           ()<br/>         )}"&gt;<br/>        { $name }<br/>      &lt;/a&gt;<br/><br/><br/>  else if ($type = "get-code") then<br/><br/>    if ($local = fn:true()) then<br/>	if (fn:count($parms) &gt; 1) then<br/>        &lt;a href="{fn:concat("javascript:popUp('xqdoc-file-", xs:string(fn:index-of(display:get-module-uris(), $parms[1])), "-", $parms[2], ".html')")}"&gt;<br/>          view code<br/>        &lt;/a&gt;<br/>      else<br/>        &lt;a href="{fn:concat("javascript:popUp('xqdoc-file-", xs:string(fn:index-of(display:get-module-uris(), $parms[1])), "_source.html')")}"&gt;<br/>          view code<br/>        &lt;/a&gt;<br/><br/>    else<br/>      if (fn:count($parms) &gt; 1) then<br/>        &lt;a href="{fn:concat("javascript:popUp('get-code.xqy?module=", $parms[1], "&amp;#38;", "function=", $parms[2], "')")}"&gt;<br/>          view code<br/>        &lt;/a&gt;<br/>      else<br/>        &lt;a href="{fn:concat("javascript:popUp('get-code.xqy?module=", $parms[1], "')")}"&gt;<br/>          view code<br/>        &lt;/a&gt;<br/>  else<br/>    ()<br/><br/>}<br/><br/>(:~<br/> :  Construct a list of module uris contained in xqDoc.<br/> :<br/> :  @return List of module uris contained in xqDoc<br/> :)<br/>define function display:get-module-uris() as xs:string*<br/>{<br/>  $display:XQDOC_URIS<br/>}<br/><br/>(:~<br/> :  Construct a list of function names defined in the current module.<br/> :<br/> :  @param $module the uri for the current module<br/> :  @return List of function names defined in the current module <br/> :)<br/>define function display:get-function-names($module as xs:string) as xs:string*<br/>{<br/>  for $function in fn:doc($module)/xq:xqdoc/xq:functions/xq:function<br/>  return<br/>  if (fn:exists($function/xq:body)) then<br/>    fn:normalize-space(xs:string($function/xq:name))<br/>  else<br/>    ()<br/>}<br/><br/>(:~<br/> :  Construct the HTML that will contain the XQuery code for the function<br/> :  in the current module (or the entire module).  The code will be <br/> :  presented via a Javascript popup Window from the module.  The lack<br/> :  of a $name parameter indicates  to construct the HTML for entire module.<br/> :  <br/> :<br/> :  @param $module the uri associated with the current module<br/> :  @param $name the name associated with the current function contained in the module<br/> :  @param $local indicates whether to build static HTML link for offline<br/> :                viewing or dynamic links for real-time viewing.<br/> :  @return HTML ... the XQuery code for the function<br/> :)<br/>define function display:get-code-html($module as xs:string, $name as xs:string?, $local as xs:boolean) as element()<br/>{<br/>  &lt;html xml:space="preserve"&gt;<br/>    &lt;head&gt;<br/>      &lt;title&gt;xqDoc -- Code Sample&lt;/title&gt;<br/>    &lt;/head&gt;<br/>    &lt;body xml:space="preserve"&gt;<br/>    &lt;pre&gt;{<br/>      if (fn:empty($name)) then<br/>        let $body := fn:doc($module)/xq:xqdoc/xq:module<br/>        return    <br/>            if (fn:exists($body/*:body[@xml:space])) then<br/>              display:print-preserve-newlines(xs:string($body/*:body[@xml:space])) <br/>            else<br/>              ()<br/>      else<br/>        let $body := fn:doc($module)/xq:xqdoc/xq:functions/xq:function[xq:name = $name]   <br/>        return      <br/>          display:print-preserve-newlines(xs:string($body/*:body[@xml:space])) <br/>    }<br/>    &lt;/pre&gt;<br/>    &lt;/body&gt;<br/>  &lt;/html&gt;<br/>}   <br/><br/>(:~<br/> :  Modify the markup (i.e. newlines) associated with an XQuery function so that <br/> :  it presents cleanly in HTML. <br/> :<br/> :  @param $strin the code associated with an XQuery function<br/> :  @return the presentation friendly version of the code <br/> :)<br/>define function display:print-preserve-newlines($strin as xs:string?) as item()*<br/>{<br/>  for $i in fn:tokenize($strin, "\n") <br/>  return ($i, &lt;br/&gt;) <br/><br/>}<br/><br/>(:~<br/> :  Get the xqDoc presentation stylesheet.  This is embedded into<br/> :  the returned XHTML for all of the presentation pages.  It is<br/> :  embedded into pages (instead of referencing a link) to keep <br/> :  things simple for the off-line viewing mode.<br/> :<br/> :  @return the stylesheet<br/> :)<br/>define function display:get-stylesheet() as element()<br/>{<br/>&lt;style&gt;<br/>&lt;!--<br/>body		{<br/>		font: 80% Verdana;<br/>		}<br/>table		{<br/>		font-size: 100%;<br/>		}<br/>h1, h2, h3, h4, h5, h6<br/>		{<br/>		clear: both;<br/>		float: none;<br/>		}<br/>h1		{<br/>		font-size: 100%;<br/>		margin: 0em;<br/>		}<br/>h2		{<br/>		font-size: 180%;<br/>		margin-bottom: -1em;<br/>		margin-top: .3em;<br/>		}<br/>h3		{<br/>		font-size: 150%;<br/>		}	<br/>h4		{<br/>		font-size: 140%;<br/>		background-color: #ccf;<br/>		border-bottom: 1px solid #99f;<br/>		width: 100%;<br/>		}<br/>h5		{<br/>		margin: 1em 0em 0em 0em;<br/>		font-size: 120%;<br/>		}<br/>h6		{<br/>		margin: 0em 0em 0em 3em;<br/>		font-style: italic;<br/>		font: bold italic;<br/>		font-size: 100%;<br/>		}<br/>#variables, #methods, #methoddetail<br/>		{<br/>		padding-left: 3em;<br/>		margin-bottom: 1.4em;<br/>		clear: both;<br/>		float: none;<br/>		}<br/>#methods ul.method, #variables ul.method<br/>		{<br/>		margin: 1em 0em 0em;<br/>		}<br/>#methoddetail ul.method<br/>		{<br/>		margin: 0em;<br/>		}<br/>div.inexternal<br/>		{<br/>		padding-left: 2em;<br/>		margin-bottom: 1em;<br/>		}<br/>div.methoddetail p<br/>		{<br/>		float: none;<br/>		clear: both;<br/>		padding-left: 2em;<br/>		margin-bottom: 1em;<br/>		}<br/>div.methoddetail{<br/>		padding-bottom: 1em;<br/>		}<br/>div.methoddetail li<br/>		{<br/>		list-style-type: none;<br/>		font-weight: bold;<br/>		}<br/>div.methoddetail li li<br/>		{<br/>		list-style-type: circle;<br/>		font-weight: normal;<br/>		}<br/>div.methoddetail li ul<br/>		{<br/>		padding-bottom: 0.5em;<br/>		font-weight: normal;<br/>		}<br/>table.inexternal{<br/>		clear: both;<br/>		float: none;<br/>		width: 80%;<br/>		margin-left: 3em;<br/>		padding: 0em;<br/>		<br/>		}<br/>table.inexternal th<br/>		{<br/>		background-color:#dedede;<br/>		width: 50%;<br/>		}			<br/>td		{<br/>		vertical-align: top;<br/>		}<br/>div.description {<br/>		margin-top: .5em;<br/>		font-weight: normal;<br/>		padding-left: 1em;<br/>		}<br/>ul.method	{<br/>		clear: both;<br/>		float: none;<br/>		width: 90%;<br/>		list-style-type: none;<br/>		border-top: 1px solid #ccc;<br/>		}<br/>ul.method li.left<br/>		{<br/>		float: left;<br/>		clear: none;<br/>		width: 40%;<br/>		font-weight: bold;<br/>		margin-bottom: 2em;<br/>		}<br/>ul.method li.right<br/>		{<br/>		position: relative;<br/>            top: 0em;<br/>		float: left;<br/>            width: 55%;<br/>		margin-bottom: 2em;<br/>		padding-left: 2em;<br/>		}<br/>div.home 	{<br/>		width: 60%;<br/>		float: left;<br/>		margin-right: 1%;<br/>		border: 1px<br/>		}<br/>div.home h4	{<br/>		font-size: 120%;<br/>		background-color: #fff;<br/>		border-bottom: 1px solid #99f;<br/>		width: 100%;<br/>		margin-bottom: -1em;<br/>		}<br/>div.overview p {<br/>               width: 60%;<br/>               }<br/>     <br/> --&gt;<br/>&lt;/style&gt;<br/>}<br/><br/><br/><br/><br/></pre></body></html>